CREATE DATABASE SSIEI CHARACTER SET utf8 COLLATE utf8_general_ci;

USE SSIEI;

CREATE TABLE Roles(
    id INT NOT NULL PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE Usuarios(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    usuarioNombre VARCHAR(50) NOT NULL,
    contrasena VARCHAR(255) NOT NULL,
    correo VARCHAR(100) NOT NULL,
    nombre VARCHAR(25) NOT NULL,
    apellido VARCHAR(25) NOT NULL,
    estado INT NOT NULL COMMENT '0=Inactivo, 1=Activo',
    rol_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE usuarios 
ADD CONSTRAINT FK_usuario_rol FOREIGN KEY (rol_id)
REFERENCES roles(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE Marcas(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE Modelos(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    marca_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE modelos 
ADD CONSTRAINT FK_modelo_marca FOREIGN KEY (marca_id)
REFERENCES marcas(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE Tipos(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE Subtipos(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    tipo_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE subtipos 
ADD CONSTRAINT FK_subtipo_tipo FOREIGN KEY (tipo_id)
REFERENCES tipos(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE Proveedores(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE Estados(
    id INT NOT NULL PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE Sedes(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    direccion TEXT NOT NULL,
    telefono INT NOT NULL,
    usuario_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE sedes 
ADD CONSTRAINT FK_sede_usuario FOREIGN KEY (usuario_id)
REFERENCES usuarios(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE Ubicaciones(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    descripcion VARCHAR(150) NOT NULL,
    sede_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE ubicaciones 
ADD CONSTRAINT FK_ubicacion_sede FOREIGN KEY (sede_id)
REFERENCES sedes(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE Activos(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    descripcion TEXT NOT NULL,
    fecha date NOT NULL,
    costo DECIMAL(10,2) NOT NULL,
    codigo VARCHAR(25) NOT NULL,
    serieNumero VARCHAR(25) NOT NULL,
    comentario TEXT NOT NULL,
    subtipo_id INT NOT NULL,
    proveedor_id INT NOT NULL,
    estado_id INT NOT NULL,
    ubicacion_id INT NOT NULL,
    modelo_id INT NOT NULL,
    usuario_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE activos 
ADD CONSTRAINT FK_activo_subtipo FOREIGN KEY (subtipo_id)
REFERENCES subtipos(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE activos 
ADD CONSTRAINT FK_activo_proveedor FOREIGN KEY (proveedor_id)
REFERENCES proveedores(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE activos 
ADD CONSTRAINT FK_activo_estado FOREIGN KEY (estado_id)
REFERENCES estados(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE activos 
ADD CONSTRAINT FK_activo_ubicacion FOREIGN KEY (ubicacion_id)
REFERENCES ubicaciones(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE activos 
ADD CONSTRAINT FK_activo_modelo FOREIGN KEY (modelo_id)
REFERENCES modelos(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE activos 
ADD CONSTRAINT FK_activo_responsable FOREIGN KEY (usuario_id)
REFERENCES usuarios(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE TicketEstados(
    id INT NOT NULL PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

CREATE TABLE Tickets(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    activo_id INT NOT NULL,
    usuario_id INT NOT NULL,
    descripcion VARCHAR(250) NOT NULL,
    fecha date NOT NULL,
    fechaRevision date NOT NULL,
    fechaCierre date NOT NULL,
    ticketestado_id INT NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE tickets 
ADD CONSTRAINT FK_ticket_activo FOREIGN KEY (activo_id)
REFERENCES activos(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE tickets 
ADD CONSTRAINT FK_ticket_responsable FOREIGN KEY (usuario_id)
REFERENCES usuarios(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE tickets 
ADD CONSTRAINT FK_ticket_estado FOREIGN KEY (ticketestado_id)
REFERENCES ticketestados(id)
ON DELETE CASCADE
ON UPDATE CASCADE

CREATE TABLE Comentarios(
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    ticket_id INT NOT NULL,
    usuario_id INT NOT NULL,
    mensaje TEXT NOT NULL,
    fecha TIMESTAMP NOT NULL
) ENGINE = INNODB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci;

ALTER TABLE comentarios 
ADD CONSTRAINT FK_comentario_ticket FOREIGN KEY (ticket_id)
REFERENCES tickets(id)
ON DELETE CASCADE
ON UPDATE CASCADE

ALTER TABLE comentarios 
ADD CONSTRAINT FK_comentario_usuario FOREIGN KEY (usuario_id)
REFERENCES usuarios(id)
ON DELETE CASCADE
ON UPDATE CASCADE